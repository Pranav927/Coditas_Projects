{% extends "base.html" %}

{% block title %}Dashboard - Inventory Management CRM{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-tachometer-alt me-2"></i>Inventory Dashboard</h2>
        <p class="text-muted mb-0">Comprehensive overview of your inventory and CRM data</p>
    </div>
    <div>
        <!-- Quick Action Buttons -->
        <a href="{% url 'add_product' %}" class="btn btn-primary me-2">
            <i class="fas fa-plus me-1"></i>Add Product
        </a>
        <a href="{% url 'add_customer' %}" class="btn btn-success me-2">
            <i class="fas fa-user-plus me-1"></i>Add Customer
        </a>
        <a href="{% url 'add_order' %}" class="btn btn-info">
            <i class="fas fa-shopping-cart me-1"></i>New Order
        </a>
    </div>
</div>

<!-- ========================================================================
KEY PERFORMANCE INDICATORS (KPI) CARDS
======================================================================== -->
<div class="row mb-4">
    <!-- Total Products Card -->
    <div class="col-md-3 mb-3">
        <div class="card card-stats text-center h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="card-title text-white mb-1">Total Products</h5>
                        <h2 class="text-white mb-0">{{ total_products|default:0 }}</h2>
                        <p class="card-text mt-2">
                            <i class="fas fa-box fa-2x text-white-50"></i>
                        </p>
                        <small class="text-white-50">Active inventory items</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Low Stock Alert Card -->
    <div class="col-md-3 mb-3">
        <div class="card text-center h-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="card-title mb-1">Low Stock Items</h5>
                        <h2 class="mb-0">{{ low_stock_products|default:0 }}</h2>
                        <p class="card-text mt-2">
                            <i class="fas fa-exclamation-triangle fa-2x text-white-50"></i>
                        </p>
                        <small class="text-white-50">Need restocking</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Total Customers Card -->
    <div class="col-md-3 mb-3">
        <div class="card text-center h-100" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="card-title mb-1">Total Customers</h5>
                        <h2 class="mb-0">{{ total_customers|default:0 }}</h2>
                        <p class="card-text mt-2">
                            <i class="fas fa-users fa-2x text-white-50"></i>
                        </p>
                        <small class="text-white-50">Active customer base</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Orders Card -->
    <div class="col-md-3 mb-3">
        <div class="card text-center h-100" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="card-title mb-1">Pending Orders</h5>
                        <h2 class="mb-0">{{ pending_orders|default:0 }}</h2>
                        <p class="card-text mt-2">
                            <i class="fas fa-clock fa-2x text-white-50"></i>
                        </p>
                        <small class="text-white-50">Awaiting processing</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========================================================================
MAIN CONTENT SECTIONS
======================================================================== -->
<div class="row">

    <!-- ========================================================================
    LOW STOCK ALERT SECTION - CRITICAL INVENTORY MANAGEMENT
    ======================================================================== -->
    {% if low_stock_items %}
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Low Stock Alert
                </h5>
                <span class="badge bg-danger">{{ low_stock_items|length }} Items</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th class="text-center">Current</th>
                                <th class="text-center">Minimum</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in low_stock_items %}
                            <tr>
                                <td>
                                    <div>
                                        <strong class="d-block">{{ product.name }}</strong>
                                        <small class="text-muted">{{ product.sku }}</small>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-danger">{{ product.quantity_in_stock }}</span>
                                </td>
                                <td class="text-center">{{ product.minimum_stock_level }}</td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'product_detail' product.id %}" class="btn btn-sm btn-outline-primary" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'add_stock_movement' %}?product={{ product.id }}" class="btn btn-sm btn-outline-success" title="Add Stock">
                                            <i class="fas fa-plus"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer bg-light">
                    <a href="{% url 'product_list' %}?stock_status=low" class="btn btn-sm btn-warning">
                        <i class="fas fa-list me-1"></i>View All Low Stock Items
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ========================================================================
    RECENT STOCK MOVEMENTS - INVENTORY ACTIVITY TRACKING
    ======================================================================== -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exchange-alt me-2"></i>Recent Stock Movements
                </h5>
                <a href="{% url 'add_stock_movement' %}" class="btn btn-sm btn-light">
                    <i class="fas fa-plus me-1"></i>Record Movement
                </a>
            </div>
            <div class="card-body p-0">
                {% if recent_stock_movements %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th class="text-center">Type</th>
                                <th class="text-center">Qty</th>
                                <th class="text-center">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for movement in recent_stock_movements %}
                            <tr>
                                <td>
                                    <div>
                                        <strong class="d-block">{{ movement.product.name }}</strong>
                                        <small class="text-muted">{{ movement.product.sku }}</small>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge 
                                        {% if movement.movement_type == 'in' %}bg-success
                                        {% elif movement.movement_type == 'out' %}bg-danger  
                                        {% else %}bg-warning text-dark{% endif %}">
                                        {{ movement.get_movement_type_display }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <strong>{{ movement.quantity }}</strong>
                                </td>
                                <td class="text-center">
                                    <small>{{ movement.created_at|date:"M d, H:i" }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-3">No recent stock movements found.</p>
                    <a href="{% url 'add_stock_movement' %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus me-1"></i>Record First Movement
                    </a>
                </div>
                {% endif %}
                <div class="card-footer bg-light">
                    <a href="{% url 'stock_movement_list' %}" class="btn btn-sm btn-outline-info">
                        <i class="fas fa-list me-1"></i>View All Movements
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========================================================================
BOTTOM ROW - ORDERS AND CUSTOMERS
======================================================================== -->
<div class="row">

    <!-- ========================================================================
    RECENT ORDERS - ORDER MANAGEMENT OVERVIEW
    ======================================================================== -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shopping-cart me-2"></i>Recent Orders
                </h5>
                <a href="{% url 'add_order' %}" class="btn btn-sm btn-light">
                    <i class="fas fa-plus me-1"></i>New Order
                </a>
            </div>
            <div class="card-body p-0">
                {% if recent_orders %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Order #</th>
                                <th>Customer/Supplier</th>
                                <th class="text-center">Status</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_orders %}
                            <tr>
                                <td>
                                    <a href="{% url 'order_detail' order.id %}" class="text-decoration-none">
                                        <strong>{{ order.order_number }}</strong>
                                    </a>
                                    <br>
                                    <small class="text-muted">{{ order.order_date|date:"M d" }}</small>
                                </td>
                                <td>
                                    <div>
                                        {% if order.customer %}
                                            <strong>{{ order.customer.first_name }} {{ order.customer.last_name }}</strong>
                                            <br><small class="text-muted">Customer</small>
                                        {% else %}
                                            <strong>{{ order.supplier.name }}</strong>
                                            <br><small class="text-muted">Supplier</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge 
                                        {% if order.status == 'pending' %}bg-warning text-dark
                                        {% elif order.status == 'confirmed' %}bg-primary
                                        {% elif order.status == 'processing' %}bg-info
                                        {% elif order.status == 'shipped' %}bg-secondary
                                        {% elif order.status == 'delivered' %}bg-success
                                        {% else %}bg-danger{% endif %}">
                                        {{ order.get_status_display }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    <strong>${{ order.total_amount|floatformat:2 }}</strong>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-3">No recent orders found.</p>
                    <a href="{% url 'add_order' %}" class="btn btn-success btn-sm">
                        <i class="fas fa-plus me-1"></i>Create First Order
                    </a>
                </div>
                {% endif %}
                <div class="card-footer bg-light">
                    <a href="{% url 'order_list' %}" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-list me-1"></i>View All Orders
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================================================
    CUSTOMER RECORDS - ORIGINAL CRM FUNCTIONALITY PRESERVED
    ======================================================================== -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i>Customer Records
                </h5>
                <a href="{% url 'add_customer' %}" class="btn btn-sm btn-light">
                    <i class="fas fa-user-plus me-1"></i>Add Customer
                </a>
            </div>
            <div class="card-body p-0">
                {% if customers %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Contact</th>
                                <th class="text-center">Type</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in customers|slice:":8" %}
                            <tr>
                                <td>
                                    <div>
                                        <strong>
                                            <a href="{% url 'customer_record' customer.id %}" class="text-decoration-none">
                                                {{ customer.first_name }} {{ customer.last_name }}
                                            </a>
                                        </strong>
                                        <br>
                                        <small class="text-muted">{{ customer.city }}, {{ customer.state }}</small>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <small class="d-block">{{ customer.email }}</small>
                                        <small class="text-muted">{{ customer.phone }}</small>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge 
                                        {% if customer.customer_type == 'business' %}bg-primary
                                        {% elif customer.customer_type == 'wholesale' %}bg-success
                                        {% else %}bg-secondary{% endif %}">
                                        {{ customer.get_customer_type_display }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'customer_record' customer.id %}" class="btn btn-sm btn-outline-primary" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'update_customer' customer.id %}" class="btn btn-sm btn-outline-success" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-3">No customers found.</p>
                    <a href="{% url 'add_customer' %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-user-plus me-1"></i>Add First Customer
                    </a>
                </div>
                {% endif %}
                <div class="card-footer bg-light d-flex justify-content-between">
                    <small class="text-muted">Showing recent customers</small>
                    <a href="#customers-section" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-list me-1"></i>View All
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========================================================================
LEGACY CUSTOMER TABLE - ORIGINAL CRM DISPLAY (HIDDEN BY DEFAULT)
======================================================================== -->
<!-- WHAT TO DO: This section preserves your original customer table display -->
<!-- It's hidden by default but can be shown by clicking "View All" above -->

<div id="customers-section" style="display: none;">
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-table me-2"></i>All Customer Records (Classic View)
            </h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('customers-section').style.display='none'">
                <i class="fas fa-times"></i> Hide Table
            </button>
        </div>
        <div class="card-body">
            {% if customers %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Address</th>
                            <th>City</th>
                            <th>State</th>
                            <th>Zipcode</th>
                            <th>Created At</th>
                            <th>ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers %}
                        <tr>
                            <td>
                                <a href="{% url 'customer_record' customer.id %}" class="text-decoration-none">
                                    {{ customer.first_name }} {{ customer.last_name }}
                                </a>
                            </td>
                            <td>{{ customer.email }}</td>
                            <td>{{ customer.phone }}</td>
                            <td>{{ customer.address }}</td>
                            <td>{{ customer.city }}</td>
                            <td>{{ customer.state }}</td>
                            <td>{{ customer.zipcode }}</td>
                            <td>{{ customer.created_at|date:"M d, Y H:i" }}</td>
                            <td>{{ customer.id }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ========================================================================
JAVASCRIPT FOR ENHANCED FUNCTIONALITY
======================================================================== -->

<script>
// Show/hide customer table
function toggleCustomersTable() {
    var section = document.getElementById('customers-section');
    if (section.style.display === 'none') {
        section.style.display = 'block';
        section.scrollIntoView({ behavior: 'smooth' });
    } else {
        section.style.display = 'none';
    }
}

// Auto-refresh dashboard data every 5 minutes
setInterval(function() {
    // You can implement AJAX refresh here if needed
    console.log('Dashboard auto-refresh (implement if needed)');
}, 300000); // 5 minutes

// Initialize tooltips
$(document).ready(function() {
    $('[title]').tooltip();
});
</script>

{% endblock %}